<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Pixy インサイト（UI）</title>
  <style>html{ -webkit-text-size-adjust: 100%; }

    :root{
      --bg:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#f3a6c8;
      --chip:#e5e7eb;
      --chipText:#111827;
      --chipActive:#111111;
      --chipActiveText:#ffffff;
      --card:#ffffff;
      --cardBorder:#d1d5db;
      --cardActiveBg:#fde7ef;
      --cardActiveBorder:#f3a6c8;
      --shadow: 0 6px 18px rgba(17,24,39,.08);
      --radius: 16px;
      --pad: 14px;

      --blue:#2563eb;
      --danger:#ff4d4f;
    }

    body{
      margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      background:var(--bg); color:var(--text);
    }
    .wrap{ max-width: 980px; margin: 0 auto; padding: 14px 14px 40px; }

    .topBar{
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 4px 12px; border-bottom: 2px solid rgba(243,166,200,.65);
      gap:12px;
    }
    .brand{ font-weight: 900; letter-spacing:.04em; font-size: 22px; }
    .brand span{ color: var(--line); }
    .title{ font-weight: 900; font-size: 18px; }

    .section{ margin-top: 16px; }
    .secLabel{ font-size: 14px; font-weight: 900; color: var(--muted); margin-bottom: 6px; }
    .secTitle{ font-size: 26px; font-weight: 900; margin: 0 0 10px; }

    .chips{ display:flex; gap:10px; flex-wrap:wrap; }
    .chip{
      border:0; background:var(--chip); color:var(--chipText);
      padding: 10px 18px; border-radius: 999px; font-weight: 900;
      cursor:pointer; box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
    }
    .chip.active{ background:var(--chipActive); color:var(--chipActiveText); }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; align-items:start; }
    @media (max-width: 860px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 2px solid var(--cardBorder);
      border-radius: 18px;
      padding: 18px;
      box-shadow: var(--shadow);
      min-height: 140px;
    }
    .card.soft{
      background: var(--cardActiveBg);
      border-color: var(--cardActiveBorder);
    }
    .cardTitle{ font-weight: 900; color: var(--muted); font-size: 14px; }
    .bigMoney{ font-weight: 900; font-size: 34px; margin-top: 6px; }
    .subLine{ margin-top: 6px; color: var(--muted); font-weight: 800; }
    .subLine b{ color: var(--text); }

    .kpiGrid{
      display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;
    }
    .kpiItem{
      border-radius: 14px; background: rgba(255,255,255,.6);
      border: 1px solid rgba(0,0,0,.08);
      padding: 12px;
    }
    .kpiItem .k{ color: var(--muted); font-weight: 900; font-size: 13px; }
    .kpiItem .v{ font-weight: 900; font-size: 22px; margin-top: 2px; }

    .tabs{ display:flex; gap:10px; margin: 14px 0 10px; }
    .tabBtn{
      border:0; background: var(--chip); color: var(--chipText);
      padding: 9px 16px; border-radius: 999px; font-weight: 900; cursor:pointer;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
    }
    .tabBtn.active{ background: var(--chipActive); color: var(--chipActiveText); }

    .chartCard{
      background:#fff; border: 2px solid rgba(0,0,0,.08);
      border-radius: 18px; padding: 12px; box-shadow: var(--shadow);
    }
    .chartTop{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom: 8px;}
    .chartTitle{ font-weight: 900; font-size: 14px; color: var(--muted); }
    .toggles{ display:flex; gap:8px; flex-wrap:wrap; }
    .toggle{
      border:0; background: var(--chip); padding: 7px 12px; border-radius: 999px;
      font-weight: 900; cursor:pointer; box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
    }
    .toggle.active{ background: var(--chipActive); color: var(--chipActiveText); }

    .chartWrap{ position: relative; height: 220px; }
    canvas{ width:100%; height:100%; }

    .detailArea{ margin-top: 18px; }
    .detailHeader{
      border-top: 2px solid rgba(243,166,200,.65);
      padding-top: 12px;
      font-weight: 900; font-size: 18px;
    }
    .detailTabs{ display:flex; gap:10px; margin-top: 10px; }
    .detailTabBtn{
      border:0; background: var(--chip); padding: 9px 16px; border-radius: 999px; font-weight: 900; cursor:pointer;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
    }
    .detailTabBtn.active{ background: var(--chipActive); color: var(--chipActiveText); }

    .detailBox{
      margin-top: 12px;
      background:#fff; border: 2px solid rgba(0,0,0,.08);
      border-radius: 18px; padding: 14px; box-shadow: var(--shadow);
    }

    .barRow{ margin-top: 12px; }
    .barTop{ display:flex; align-items:center; justify-content:space-between; font-weight: 900; }
    .barBg{
      margin-top: 8px; height: 12px; border-radius: 999px; background:#e5e7eb; overflow:hidden;
    }
    .barFill{ height:100%; width:0%; background: var(--blue); border-radius: 999px; }
    .smallNote{ color: var(--muted); font-weight: 800; font-size: 12px; margin-top: 4px; }

    .ratioRow{ margin-top: 14px; }
    .ratioLine{ height: 12px; border-radius: 999px; overflow:hidden; background:#e5e7eb; position:relative; }
    .ratioA{ position:absolute; left:0; top:0; bottom:0; width:50%; background: var(--line); }
    .ratioB{ position:absolute; right:0; top:0; bottom:0; width:50%; background:#111111; }

    .rows{ margin-top: 10px; }
    .row{
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,.06);
      font-weight: 900;
    }
    .row:last-child{ border-bottom: 0; }
    .rLabel{ color: var(--muted); font-weight: 900; }
    .rVal{ font-weight: 900; }

    /* 回数別 */
    .p2Box{
      margin-top: 14px;
      background:#fff; border: 2px solid rgba(0,0,0,.08);
      border-radius: 18px; padding: 14px; box-shadow: var(--shadow);
    }
    .p2Title{ font-weight: 900; font-size: 16px; margin-bottom: 10px; }
    .p2TableHeader{
      display:grid; grid-template-columns: 90px 1fr 90px 90px;
      gap: 10px; align-items:center; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,.06);
      font-size: 12px; font-weight: 800;
    }
    .p2Row{
      display:grid; grid-template-columns: 90px 1fr 90px 90px;
      gap: 10px; align-items:center; padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,.06);
      font-weight: 900;
    }
    .p2Row:last-child{ border-bottom: 0; }
    .p2BarBg{ height: 8px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
    .p2BarFill{ height: 100%; background: var(--blue); width: 0%; border-radius:999px; }
    .endTitle{ margin-top: 14px; font-size: 12px; font-weight: 900; color: #111827; }
    .endItem{
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 12px; border: 1px solid rgba(0,0,0,.08); border-radius: 14px;
      background:#fff; margin-top: 8px;
    }
    .endLabel{ font-size: 13px; font-weight: 900; }
    .endVal{ font-size: 13px; font-weight: 900; color: var(--muted); }

    .ctaRow{ display:flex; justify-content:flex-end; margin-top: 12px; }
    .cta{
      display:inline-flex; align-items:center; justify-content:center; border:0;
      padding: 10px 18px; border-radius: 999px; background: var(--danger); color:#fff;
      font-weight: 900; font-size: 14px; text-decoration:none;
    }

    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topBar">
      <div class="brand">Pi<span>xy</span></div>
      <div class="title">インサイト</div>
      <div style="width:58px"></div>
    </div>

    <div class="section">
      <div class="secLabel">鑑定師名</div>
    </div>

    <div class="section">
      <div class="secTitle">メインデータ</div>
      <div class="chips" id="monthChips"></div>

      <div class="grid2" style="margin-top:14px;">
        <div class="card" id="moneyCard">
          <div class="cardTitle">今月の報酬金</div>
          <div class="bigMoney" id="moneyVal">—</div>
          <div class="subLine">前月比　<b id="moneyMoM">—</b></div>
        </div>

        <div class="card soft">
          <div class="cardTitle" style="font-size:16px; color:#111827;">鑑定データ詳細</div>
          <div style="display:flex; gap:22px; margin-top:10px; flex-wrap:wrap;">
            <div>
              <div class="cardTitle">リピート件数</div>
              <div class="kpiItem" style="padding:0; border:0; background:transparent;">
                <div class="v" id="repeatCount" style="font-size:26px;">—</div>
              </div>
            </div>
            <div>
              <div class="cardTitle">リピート人数</div>
              <div class="kpiItem" style="padding:0; border:0; background:transparent;">
                <div class="v" id="repeatUsers" style="font-size:26px;">—</div>
              </div>
            </div>
          </div>

          <div class="kpiGrid">
            <div class="kpiItem">
              <div class="k">鑑定件数</div>
              <div class="v" id="kanteiCount">—</div>
            </div>
            <div class="kpiItem">
              <div class="k">鑑定人数</div>
              <div class="v" id="kanteiUsers">—</div>
            </div>
          </div>
        </div>
      </div>

      <div class="tabs">
        <button class="tabBtn active" data-main="kpi">メインデータ</button>
        <button class="tabBtn" data-main="p2">回数別</button>
      </div>

      <div id="viewKPI">
        <div class="chartCard">
          <div class="chartTop">
            <div class="chartTitle">報酬金（グラフ）</div>
            <div class="toggles">
              <button class="toggle active" data-mode="hour">時間別</button>
              <button class="toggle" data-mode="weekday">曜日別</button>
              <button class="toggle" data-mode="day">日別</button>
            </div>
          </div>
          <div class="chartWrap">
            <canvas id="chart"></canvas>
          </div>
          <div class="smallNote" id="chartNote">—</div>
        </div>
      </div>

      <div id="viewDetail" class="hidden">
        <div class="p2Box">
          <div class="p2Title">回数別ユーザー数</div>
          <div class="p2TableHeader">
            <div>区分</div>
            <div></div>
            <div style="text-align:right;">人数</div>
            <div style="text-align:right;">割合</div>
          </div>
          <div id="p2Rows"></div>
          <div class="endTitle">終了回数の一覧</div>
          <div id="endList"></div>
</div>
      </div>

      <div class="detailArea">
        <div class="detailHeader">詳細データ</div>
        <div class="detailTabs">
          <button class="detailTabBtn active" data-detail="user">ユーザー分析</button>
          <button class="detailTabBtn" data-detail="kanteishi">鑑定師分析</button>
        </div>

        <div class="detailBox" id="detailUser">
          <div class="cardTitle" style="font-size:14px; color:#111827;">年齢構成比</div>
          <div id="ageBars"></div>

          <div class="ratioRow">
            <div class="cardTitle" style="font-size:14px; color:#111827;">男女比率</div>
            <div class="ratioLine" style="margin-top:8px;">
              <div class="ratioA" id="ratioFemale" style="width:50%"></div>
              <div class="ratioB" id="ratioMale" style="width:50%"></div>
            </div>
            <div class="rows" style="margin-top:8px;">
              <div class="row"><div class="rLabel">女性</div><div class="rVal" id="femalePct">—</div></div>
              <div class="row"><div class="rLabel">男性</div><div class="rVal" id="malePct">—</div></div>
            </div>
          </div>
        </div>

        <div class="detailBox hidden" id="detailKanteishi">
          <div class="rows">
            <div class="row"><div class="rLabel">待機時間</div><div class="rVal" id="waitThis">—</div></div>
            <div class="row"><div class="rLabel">今月の待機時間</div><div class="rVal" id="waitThis2">—</div></div>
            <div class="row"><div class="rLabel">前月の待機時間</div><div class="rVal" id="waitPrev">—</div></div>
            <div class="row"><div class="rLabel">前月比</div><div class="rVal" id="waitMoM">—</div></div>
          </div>

          <div style="height:12px"></div>
          <div class="cardTitle" style="font-size:14px; color:#111827;">アフターメッセージ</div>
          <div class="rows">
            <div class="row"><div class="rLabel">鑑定件数</div><div class="rVal" id="amTotal">—</div></div>
            <div class="row"><div class="rLabel">送信数</div><div class="rVal" id="amSent">—</div></div>
            <div class="row"><div class="rLabel">未送信</div><div class="rVal" id="amUnsent">—</div></div>
            <div class="row"><div class="rLabel">送信率</div><div class="rVal" id="amRate">—</div></div>
          </div>
        </div>
      </div>

      <div style="height:12px"></div>
    </div>

<script>
  const el = (id) => document.getElementById(id);

  function yen(n){
    if(n==null || isNaN(n)) return "—";
    return "¥ " + Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }
  function pctText(n){
    if(n==null || isNaN(n)) return "—";
    const v = Math.round(n*10)/10;
    return v.toString().replace(/\.0$/,"") + "%";
  }
  function hoursText(n){
    if(n==null || isNaN(n)) return "—";
    const v = Math.round(n*10)/10;
    return v.toString().replace(/\.0$/,"");
  }

  // ===== 修正: グラフの点数をモードごとに正規化（時間=24 / 曜日=7 / 日=31） =====
  // もともとのデータが「0時,3時,6時...」のように間引かれていても、
  // ここで「存在しない点は0」として埋めて、1つずつ確認できるようにします。
  const _chartNormCache = {};
  function getNormalizedChartData(month, mode){
    const key = month + "::" + mode;
    if(_chartNormCache[key]) return _chartNormCache[key];

    const raw = APP.dataByMonth[month].chart || {};
    const labels = raw.labels || [];
    const values = raw.values || [];

    let fullLabels = [];
    let fullValues = [];

    if(mode === "hour"){
      // 0am〜23pm
      fullLabels = Array.from({length:24}, (_,i)=> `${i}am`);
      const map = {};
      for(let i=0;i<labels.length;i++){
        const lab = labels[i];
        const m = String(lab).match(/^(\d+)(am|pm)$/);
        if(!m) continue;
        const h = parseInt(m[1],10);
        // ここは既に "0am..23pm" の想定。違う場合はそのまま当てる。
        map[lab] = values[i];
      }
      fullValues = fullLabels.map(l=> (map[l] ?? 0));
    } else if(mode === "weekday"){
      // 日〜土（7）
      fullLabels = ["日","月","火","水","木","金","土"];
      const map = {};
      for(let i=0;i<labels.length;i++){
        map[labels[i]] = values[i];
      }
      fullValues = fullLabels.map(l=> (map[l] ?? 0));
    } else {
      // day: 1日〜31日（31）
      fullLabels = Array.from({length:31}, (_,i)=> `${i+1}日`);
      const map = {};
      for(let i=0;i<labels.length;i++){
        map[labels[i]] = values[i];
      }
      fullValues = fullLabels.map(l=> (map[l] ?? 0));
    }

    const out = { labels: fullLabels, values: fullValues };
    _chartNormCache[key] = out;
    return out;
  }
  // ===== 修正ここまで =====

const APP = {
    months: ["12月", "11月", "10月", "9月", "8月"],
    state: { month: "12月", mainTab: "kpi", chartMode: "hour", detailTab: "user", cursorIndex: null },
    dataByMonth: {"12月":{"money":88270,"mom":56.6,"repeatCnt":21,"repeatUsers":15,"kanteiCnt":139,"kanteiUsers":118,"chart":{"labels":["0am","1am","2am","3am","4am","5am","6am","7am","8am","9am","10am","11am","12am","13pm","14pm","15pm","16pm","17pm","18pm","19pm","20pm","21pm","22pm","23pm"],"values":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},"chartWeekday":{"labels":["日","月","火","水","木","金","土"],"values":[0,0,0,0,0,0,0]},"chartDay":{"labels":["1日","2日","3日","4日","5日","6日","7日","8日","9日","10日","11日","12日","13日","14日","15日","16日","17日","18日","19日","20日","21日","22日","23日","24日","25日","26日","27日","28日","29日","30日","31日"],"values":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},"user":{"age":[{"label":"-24","pct":0},{"label":"25-34","pct":0},{"label":"35-44","pct":0},{"label":"45-54","pct":0},{"label":"55-64","pct":0},{"label":"65-","pct":0}],"female":0,"male":0},"kanteishi":{"waitThis":null,"waitPrev":null,"waitMoM":null,"after":{"total":null,"sent":null,"unsent":null,"rate":null}},"p2":{"counts":[{"label":"1回","n":103,"pct":87.3},{"label":"2回","n":9,"pct":7.6},{"label":"3回","n":6,"pct":5.1},{"label":"4回","n":0,"pct":0},{"label":"5回以上","n":0,"pct":0}]}},
"11月":{"money":0,"mom":null,"repeatCnt":0,"repeatUsers":0,"kanteiCnt":0,"kanteiUsers":0,"chart":{"labels":
