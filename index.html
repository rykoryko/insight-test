<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Pixy インサイト</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#f3a6c8;
      --chip:#e5e7eb;
      --chipText:#111827;
      --chipActive:#111111;
      --chipActiveText:#ffffff;
      --card:#ffffff;
      --cardBorder:#d1d5db;
      --cardActiveBg:#fde7ef;
      --cardActiveBorder:#f3a6c8;
      --bar:#2563eb;
      --barBg:#e5e7eb;
      --shadow: 0 8px 24px rgba(17,24,39,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html{ -webkit-text-size-adjust: 100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width: 420px;
      margin: 0 auto;
      padding: 18px 16px 48px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:flex-end;
      gap:10px;
    }
    .brand .pixy{font-weight:800; font-size:36px; letter-spacing:.2px;}
    .brand .insight{font-weight:800; font-size:26px;}
    .btnJson{
      border:0;
      background:#111111;
      color:#fff;
      padding:10px 18px;
      border-radius:999px;
      font-weight:700;
      cursor:pointer;
    }
    .meta{
      margin-top:6px;
      color:var(--muted);
      font-size:14px;
    }
    .hrPink{
      height:3px;
      background:var(--line);
      border-radius:999px;
      margin:14px 0 18px;
    }

    .kanteishiLine{
      padding:10px 0 6px;
      border-top:2px solid var(--line);
      border-bottom:2px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .kanteishiLine .label{font-weight:800}
    .kanteishiLine .value{color:var(--muted); font-weight:700}

    .months{
      display:flex;
      gap:10px;
      margin:14px 0 16px;
      overflow:auto;
      padding-bottom:2px;
    }
    .chip{
      border:0;
      background:var(--chip);
      color:var(--chipText);
      padding:10px 14px;
      border-radius:999px;
      font-weight:800;
      cursor:pointer;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .chip.active{
      background:var(--chipActive);
      color:var(--chipActiveText);
    }

    .sectionTitle{
      font-weight:900;
      font-size:20px;
      margin: 8px 0 12px;
      border-bottom:3px solid var(--line);
      padding-bottom:8px;
    }

    .cards2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-bottom:12px;
    }
    .card{
      background:var(--card);
      border:2px solid var(--cardBorder);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px 14px 12px;
    }
    .card.clickable{cursor:pointer; user-select:none;}
    .card.active{
      border-color: var(--cardActiveBorder);
      background: var(--cardActiveBg);
    }
    .card .small{
      color:var(--muted);
      font-weight:800;
      font-size:13px;
      margin-bottom:10px;
    }
    .bigMoney{
      font-size:34px;
      font-weight:900;
      letter-spacing:.3px;
      line-height:1.0;
    }
    .moneyUnit{font-size:18px; font-weight:900; margin-left:4px}
    .subRow{
      margin-top:10px;
      color:var(--muted);
      font-weight:800;
      font-size:14px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px 12px;
    }
    .kv .k{color:var(--muted); font-size:12px; font-weight:900}
    .kv .v{font-size:24px; font-weight:900; margin-top:2px}

    .panel{display:none;}
    .panel.show{display:block;}

    .graphBox{
      background:#fff;
      border:2px solid var(--cardBorder);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
      margin: 10px 0 18px;
    }
    .graphHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .graphHead .title{font-weight:900}
    .tabs{
      display:flex;
      gap:10px;
      overflow:auto;
      padding-bottom:2px;
    }
    .tab{
      border:0;
      background:var(--chip);
      color:var(--chipText);
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .tab.active{background:var(--chipActive); color:var(--chipActiveText);}

    .bars{
      display:flex;
      align-items:flex-end;
      gap:6px;
      height:150px;
      padding:6px 4px 2px;
      border-radius:14px;
      background:#fff;
      border:1px solid #eef2f7;
      overflow:hidden;
    }
    .bar{
      width:10px;
      background: #111827;
      border-radius:8px 8px 2px 2px;
      flex: 0 0 auto;
      opacity:.9;
    }
    .xlabels{
      display:flex;
      gap:6px;
      margin-top:8px;
      overflow:auto;
      padding-bottom:2px;
    }
    .xlabel{
      width:10px;
      flex:0 0 auto;
      font-size:10px;
      color:var(--muted);
      text-align:center;
      transform: translateX(-2px);
      white-space:nowrap;
    }
    .graphFoot{
      display:flex;
      justify-content:space-between;
      align-items:center;
      color:var(--muted);
      font-weight:900;
      margin-top:8px;
    }

    .listBox{
      background:#fff;
      border:2px solid var(--cardBorder);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
      margin: 10px 0 18px;
    }
    .distHeader{
      display:grid;
      grid-template-columns: 80px 1fr 70px 60px;
      gap:10px;
      color:var(--muted);
      font-weight:900;
      font-size:12px;
      padding:0 4px 6px;
    }
    .distRow{
      display:grid;
      grid-template-columns: 80px 1fr 70px 60px;
      gap:10px;
      align-items:center;
      padding:10px 4px;
      border-top:1px solid #eef2f7;
    }
    .distRow .label{font-weight:900}
    .barWrap{
      height:10px;
      background:var(--barBg);
      border-radius:999px;
      overflow:hidden;
    }
    .barFill{
      height:100%;
      background:var(--bar);
      border-radius:999px;
      width:0%;
    }
    .distRow .n{font-weight:900; text-align:right}
    .distRow .p{font-weight:900; color:var(--muted); text-align:right}

    .endListTitle{
      font-weight:900;
      margin: 4px 0 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .pillCount{
      background:#f3f4f6;
      border-radius:999px;
      padding:6px 10px;
      font-weight:900;
      color:#111827;
      font-size:12px;
    }
    details.endItem{
      border-top:1px solid #eef2f7;
      padding:10px 0;
    }
    details.endItem summary{
      cursor:pointer;
      list-style:none;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-weight:900;
    }
    details.endItem summary::-webkit-details-marker{display:none;}
    .endUsers{
      margin-top:10px;
      display:grid;
      gap:8px;
    }
    .u{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      background:#f9fafb;
      border:1px solid #eef2f7;
      border-radius:999px;
      padding:8px 12px;
      font-weight:800;
    }
    .u .left{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .badge{
      width:26px;
      height:26px;
      border-radius:999px;
      background:#eef2f7;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:12px;
    }
    .err{
      color:#b91c1c;
      font-weight:900;
      margin-top:12px;
      white-space:pre-wrap;
    }
    .hint{
      color:var(--muted);
      font-weight:800;
      margin-top:8px;
      font-size:13px;
    }
    .hiddenFile{display:none;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="pixy">Pixy</div>
        <div class="insight">インサイト</div>
      </div>
      <button class="btnJson" id="btnJson">JSON</button>
      <input class="hiddenFile" id="fileJson" type="file" accept=".json,application/json" />
    </div>

    <div class="meta" id="metaLine">生成: -</div>
    <div class="hrPink"></div>

    <div class="kanteishiLine">
      <div class="label">鑑定師名</div>
      <div class="value" id="kanteishiName">-</div>
    </div>

    <div class="months" id="monthChips"></div>

    <div class="sectionTitle">メインデータ</div>

    <div class="cards2">
      <div class="card clickable active" id="cardGraph" role="button" aria-label="グラフを表示">
        <div class="small">今月の報酬金</div>
        <div><span class="bigMoney" id="revThis">-</span><span class="moneyUnit">円</span></div>
        <div class="subRow">前月比　<span id="revMom">-</span>%</div>
      </div>

      <div class="card clickable" id="cardCounts" role="button" aria-label="回数別/終了回数を表示">
        <div class="small">鑑定データ詳細</div>
        <div class="grid2">
          <div class="kv">
            <div class="k">リピート件数</div>
            <div class="v" id="repCount">-</div>
          </div>
          <div class="kv">
            <div class="k">リピート人数</div>
            <div class="v" id="repUsers">-</div>
          </div>
          <div class="kv">
            <div class="k">鑑定件数</div>
            <div class="v" id="kCount">-</div>
          </div>
          <div class="kv">
            <div class="k">鑑定人数</div>
            <div class="v" id="kUsers">-</div>
          </div>
        </div>
      </div>
    </div>

    <section class="panel show" id="panelGraph">
      <div class="graphBox">
        <div class="graphHead">
          <div class="title">報酬金グラフ</div>
          <div class="right" id="graphModeLabel">時間別</div>
        </div>
        <div class="tabs" id="graphTabs">
          <button class="tab active" data-mode="time">時間別</button>
          <button class="tab" data-mode="weekday">曜日別</button>
          <button class="tab" data-mode="day">日別</button>
        </div>
        <div class="bars" id="bars"></div>
        <div class="xlabels" id="xlabels"></div>
        <div class="graphFoot">
          <div>合計：<span id="graphSum">-</span> 円</div>
          <div>選択：<span id="graphPick">なし</span></div>
        </div>
      </div>

      <div class="listBox">
        <div class="endListTitle">
          <span>待機</span>
          <span class="pillCount" id="standbyNote">今月 / 前月 / 前月比</span>
        </div>
        <div class="grid2">
          <div class="kv"><div class="k">今月</div><div class="v" id="sbThis">-</div></div>
          <div class="kv"><div class="k">前月</div><div class="v" id="sbPrev">-</div></div>
          <div class="kv"><div class="k">前月比</div><div class="v" id="sbMom">-</div></div>
          <div class="kv"><div class="k"></div><div class="v"></div></div>
        </div>
      </div>

      <div class="listBox">
        <div class="endListTitle">
          <span>お礼メール</span>
          <span class="pillCount">送信数 / 送信率</span>
        </div>
        <div class="grid2">
          <div class="kv"><div class="k">送信数</div><div class="v" id="amSent">-</div></div>
          <div class="kv"><div class="k">対象（終了数）</div><div class="v" id="amTotal">-</div></div>
          <div class="kv"><div class="k">送信率</div><div class="v" id="amRate">-</div></div>
          <div class="kv"><div class="k"></div><div class="v"></div></div>
        </div>
      </div>
    </section>

    <section class="panel" id="panelCounts">
      <div class="listBox">
        <div class="endListTitle">
          <span>回数別ユーザー数</span>
          <span class="pillCount">合計 <span id="distTotal">-</span>人</span>
        </div>
        <div class="distHeader">
          <div></div><div></div><div style="text-align:right;">人数</div><div style="text-align:right;">割合</div>
        </div>
        <div id="distRows"></div>
      </div>

      <div class="listBox">
        <div class="endListTitle">
          <span>終了回数の一覧</span>
          <span class="pillCount" id="endPickLabel">-</span>
        </div>
        <div id="endList"></div>
        <div class="hint">※「さらに表示」は未実装（必要なら追加する）</div>
      </div>
    </section>

    <div class="err" id="err"></div>
  </div>

<script>
(function(){
  let INSIGHT = null;
  let currentMonth = null;
  let graphMode = 'time';

  const $ = (id)=>document.getElementById(id);

  function yen(n){
    if(n===null || n===undefined) return '-';
    const x = Number(n);
    if(!Number.isFinite(x)) return '-';
    return x.toLocaleString('ja-JP');
  }
  function num(n){
    if(n===null || n===undefined) return '-';
    const x = Number(n);
    if(!Number.isFinite(x)) return '-';
    return String(x);
  }
  function pct(n){
    if(n===null || n===undefined) return '-';
    const x = Number(n);
    if(!Number.isFinite(x)) return '-';
    return x.toFixed(1).replace(/\.0$/,'');
  }
  function safe(obj, path, fallback=null){
    try{
      const parts = path.split('.');
      let cur = obj;
      for(const p of parts){
        if(cur==null) return fallback;
        cur = cur[p];
      }
      return (cur===undefined) ? fallback : cur;
    }catch(e){ return fallback; }
  }

  function setView(mode){
    const isGraph = (mode === 'graph');
    $('panelGraph').classList.toggle('show', isGraph);
    $('panelCounts').classList.toggle('show', !isGraph);
    $('cardGraph').classList.toggle('active', isGraph);
    $('cardCounts').classList.toggle('active', !isGraph);
    localStorage.setItem('pixy_view_mode', mode);
  }

  $('cardGraph').addEventListener('click', ()=>setView('graph'));
  $('cardCounts').addEventListener('click', ()=>setView('counts'));
  setView(localStorage.getItem('pixy_view_mode') || 'graph');

  $('btnJson').addEventListener('click', ()=> $('fileJson').click());
  $('fileJson').addEventListener('change', async (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    try{
      const txt = await f.text();
      INSIGHT = JSON.parse(txt);
      initAfterLoad();
    }catch(err){
      showErr('JSONの読み込みに失敗: ' + err);
    }
  });

  async function autoLoad(){
    try{
      const res = await fetch('insight_data.json', {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const txt = await res.text();
      INSIGHT = JSON.parse(txt);
      initAfterLoad();
    }catch(err){
      $('metaLine').textContent = '生成: -（JSON未読み込み）';
      $('kanteishiName').textContent = '-';
      $('monthChips').innerHTML = '';
      $('err').textContent = '';
    }
  }

  function initAfterLoad(){
    $('err').textContent = '';
    const gen = safe(INSIGHT,'generated_at','-');
    const exclude = safe(INSIGHT,'target.exclude_under_seconds',60);
    $('metaLine').textContent = `生成: ${gen}（${exclude}秒未満除外: ${exclude}s）`;

    const name = safe(INSIGHT,'target.name','-');
    const kid = safe(INSIGHT,'target.kid','-');
    $('kanteishiName').textContent = `${name}（KID:${kid}）`;

    const months = safe(INSIGHT,'months',[]);
    if(months.length){
      currentMonth = currentMonth && months.includes(currentMonth) ? currentMonth : months[0];
    }

    renderMonthChips(months);
    renderAll();
  }

  function renderMonthChips(months){
    const box = $('monthChips');
    box.innerHTML = '';
    const show = months.slice(0,5);
    for(const m of show){
      const mm = m.split('-')[1];
      const btn = document.createElement('button');
      btn.className = 'chip' + (m===currentMonth ? ' active':'');
      btn.textContent = Number(mm) + '月';
      btn.addEventListener('click', ()=>{
        currentMonth = m;
        for(const el of box.querySelectorAll('.chip')) el.classList.remove('active');
        btn.classList.add('active');
        renderAll();
      });
      box.appendChild(btn);
    }
  }

  function renderAll(){
    if(!INSIGHT || !currentMonth) return;

    const d = safe(INSIGHT, `data.${currentMonth}`, null);
    if(!d){
      showErr('この月のデータがありません: ' + currentMonth);
      return;
    }

    $('revThis').textContent = yen(safe(d,'revenue.this',null));
    $('revMom').textContent  = pct(safe(d,'revenue.mom_pct',null));

    const repCount = safe(d,'summary.repeat_count', safe(d,'repeat.repeat_count', safe(d,'repeat.count', null)));
    const repUsers = safe(d,'summary.repeat_users', safe(d,'summary.repeat_user_count', null));
    const kCount   = safe(d,'summary.kantei_count', safe(d,'summary.call_count', null));
    const kUsers   = safe(d,'summary.users_total', safe(d,'summary.user_count', null));

    $('repCount').textContent = num(repCount);
    $('repUsers').textContent = num(repUsers);
    $('kCount').textContent   = num(kCount);
    $('kUsers').textContent   = num(kUsers);

    if($('repUsers').textContent === '-' && safe(d,'repeat.distribution',null)){
      const dist = safe(d,'repeat.distribution',[]);
      let sum = 0;
      for(const row of dist){
        const lab = String(row.label||'');
        if(lab.includes('1回')) continue;
        sum += Number(row.users||0);
      }
      $('repUsers').textContent = sum ? String(sum) : '-';
    }
    if($('repCount').textContent === '-' && safe(d,'repeat.details',null)){
      const det = safe(d,'repeat.details',{});
      let cnt = 0;
      for(const k in det){
        if(String(k).includes('1回')) continue;
        cnt += (det[k]||[]).length;
      }
      $('repCount').textContent = cnt ? String(cnt) : '-';
    }
    if($('kCount').textContent === '-' && safe(d,'after_message.phone_count',null)!=null){
      $('kCount').textContent = String(Number(safe(d,'after_message.phone_count',0)) || '-');
    }

    graphMode = graphMode || 'time';
    renderGraph(d);

    $('sbThis').textContent = safe(d,'standby.this_text','-');
    $('sbPrev').textContent = safe(d,'standby.prev_text','-');
    $('sbMom').textContent  = (safe(d,'standby.mom_pct',null)==null) ? '-' : (pct(safe(d,'standby.mom_pct',null)) + '%');

    $('amSent').textContent = num(safe(d,'after_message.sent_count',null));
    $('amTotal').textContent= num(safe(d,'after_message.phone_count',null));
    const r = safe(d,'after_message.send_rate_pct',null);
    $('amRate').textContent = (r==null) ? '-' : (pct(r) + '%');

    renderDistribution(d);
    renderEndList(d, '1回');
  }

  $('graphTabs').addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-mode]');
    if(!btn || !INSIGHT) return;
    graphMode = btn.getAttribute('data-mode');
    for(const b of $('graphTabs').querySelectorAll('.tab')) b.classList.remove('active');
    btn.classList.add('active');
    renderAll();
  });

  function renderGraph(d){
    const modes = {time:'時間別', weekday:'曜日別', day:'日別'};
    $('graphModeLabel').textContent = modes[graphMode] || '時間別';

    const arr = safe(d, `graphs.${graphMode}`, []);
    const bars = $('bars');
    const xlabels = $('xlabels');
    bars.innerHTML = '';
    xlabels.innerHTML = '';

    if(!arr || !arr.length){
      $('graphSum').textContent = '-';
      return;
    }

    const values = arr.map(x=>Number(x.value||0));
    const max = Math.max(1, ...values);
    let sum = 0;

    arr.forEach((x,i)=>{
      const v = Number(x.value||0);
      sum += v;

      const div = document.createElement('div');
      div.className = 'bar';
      div.style.height = Math.round((v/max)*150) + 'px';
      div.title = `${x.label}: ${yen(v)}円`;
      div.addEventListener('click', ()=>{
        $('graphPick').textContent = `${x.label} / ${yen(v)}円`;
      });
      bars.appendChild(div);

      const lab = document.createElement('div');
      lab.className = 'xlabel';
      lab.textContent = x.label;
      xlabels.appendChild(lab);
    });

    $('graphSum').textContent = yen(sum);
    $('graphPick').textContent = 'なし';
  }

  function renderDistribution(d){
    const dist = safe(d,'repeat.distribution',[]);
    const box = $('distRows');
    box.innerHTML = '';

    let total = 0;
    dist.forEach(r=> total += Number(r.users||0));
    $('distTotal').textContent = total ? String(total) : '-';

    const max = Math.max(1, ...dist.map(r=>Number(r.users||0)));

    dist.forEach(r=>{
      const row = document.createElement('div');
      row.className = 'distRow';

      const label = document.createElement('div');
      label.className = 'label';
      label.textContent = r.label || '-';

      const wrap = document.createElement('div');
      wrap.className = 'barWrap';
      const fill = document.createElement('div');
      fill.className = 'barFill';
      fill.style.width = Math.round((Number(r.users||0)/max)*100) + '%';
      wrap.appendChild(fill);

      const n = document.createElement('div');
      n.className = 'n';
      n.textContent = (r.users==null) ? '-' : (String(r.users) + '人');

      const p = document.createElement('div');
      p.className = 'p';
      p.textContent = (r.pct==null) ? '-' : (pct(r.pct) + '%');

      row.appendChild(label);
      row.appendChild(wrap);
      row.appendChild(n);
      row.appendChild(p);

      box.appendChild(row);
    });
  }

  function renderEndList(d, pickLabel){
    const details = safe(d,'repeat.details', {});
    const list = $('endList');
    list.innerHTML = '';

    const items = details && details[pickLabel] ? details[pickLabel] : [];
    $('endPickLabel').textContent = pickLabel + 'で終了 ' + (items.length ? (items.length + '人') : '0人');

    if(!items.length){
      const div = document.createElement('div');
      div.className = 'hint';
      div.textContent = '該当データがありません。';
      list.appendChild(div);
      return;
    }

    const det = document.createElement('details');
    det.className = 'endItem';
    det.open = true;

    const sum = document.createElement('summary');
    sum.innerHTML = `<span>${pickLabel}で終了</span><span class="pillCount">${items.length}人</span>`;
    det.appendChild(sum);

    const users = document.createElement('div');
    users.className = 'endUsers';

    items.slice(0, 200).forEach((u,i)=>{
      const row = document.createElement('div');
      row.className = 'u';
      const left = document.createElement('div');
      left.className = 'left';
      const badge = document.createElement('div');
      badge.className = 'badge';
      badge.textContent = String(u.count || 1);
      const id = document.createElement('div');
      id.textContent = String(u.user_id || '-');
      left.appendChild(badge);
      left.appendChild(id);

      const dt = document.createElement('div');
      dt.style.color = '#6b7280';
      dt.style.fontWeight = '900';
      dt.style.fontSize = '12px';
      dt.textContent = u.datetime || u.date || '';

      row.appendChild(left);
      row.appendChild(dt);
      users.appendChild(row);
    });

    det.appendChild(users);
    list.appendChild(det);
  }

  function showErr(msg){
    $('err').textContent = msg;
  }

  autoLoad();
})();
</script>
</body>
</html>
