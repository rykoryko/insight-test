<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Pixy インサイト（UI）</title>
  <style>html{ -webkit-text-size-adjust: 100%; }

    :root{
      --bg:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#f3a6c8;
      --chip:#e5e7eb;
      --chipText:#111827;
      --chipActive:#111111;
      --chipActiveText:#ffffff;
      --card:#ffffff;
      --cardBorder:#d1d5db;
      --cardActiveBg:#fde7ef;
      --cardActiveBorder:#f3a6c8;
      --shadow: 0 6px 18px rgba(17,24,39,.08);
      --radius: 16px;
      --pad: 14px;
      --font: 14px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; background: var(--bg); color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", "Meiryo", sans-serif;
      font-size: var(--font);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .page{
      max-width: 520px; margin: 0 auto; padding: 10px 10px 40px;
    }
    .top{
      display:flex; align-items:center; justify-content:space-between;
      padding: 8px 6px 6px;
      position: sticky; top:0; background: var(--bg); z-index: 30;
    }
    .logo{ font-weight:900; letter-spacing:.06em; }
    .logo span{ color:#f08bb6; }
    .title{ font-weight:900; letter-spacing:.12em; color:#1f2937; }

    .hr{ height:2px; background: linear-gradient(90deg, transparent, var(--line), transparent); margin: 8px 0 10px; }
    .sectionTitle{
      font-weight: 900; font-size: 16px; margin: 12px 0 8px;
    }
    .label{ font-size: 12px; color: var(--muted); font-weight: 800; margin: 6px 0 8px; }

    .chipRow{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{
      border:0; background: var(--chip); color: var(--chipText);
      padding: 6px 12px; border-radius: 999px;
      font-weight: 900; cursor: pointer;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.04);
      user-select:none;
    }
    .chip.active{
      background: var(--chipActive);
      color: var(--chipActiveText);
    }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .card{
      background: var(--card);
      border-radius: var(--radius);
      border: 1.5px solid var(--cardBorder);
      box-shadow: var(--shadow);
      padding: var(--pad);
    }
    .card.active{
      background: var(--cardActiveBg);
      border-color: var(--cardActiveBorder);
    }
    .cardTitle{
      font-size: 12px; color: var(--muted); font-weight: 900; margin: 0 0 6px;
    }
    .bigMoney{
      font-size: 22px; font-weight: 900; letter-spacing:.02em; margin: 2px 0 6px;
    }
    .kpiRow{
      display:flex; gap:10px; align-items:baseline; justify-content:space-between;
    }
    .kpiSub{ font-size: 12px; color: var(--muted); font-weight: 900; }
    .kpiSub strong{ color: var(--text); }

    .miniGrid{
      display:grid; grid-template-columns: 1fr 1fr; gap:6px;
      margin-top: 8px;
    }
    .miniKpi{
      background: rgba(255,255,255,.65);
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.06);
      padding: 8px 8px;
    }
    .miniKpi .k{ font-size: 11px; color: var(--muted); font-weight: 900; }
    .miniKpi .v{ font-size: 18px; font-weight: 900; margin-top:2px; }

    .tabRow{
      display:flex; gap:8px; flex-wrap:wrap; margin: 10px 0 8px;
    }
    .tabBtn{
      border:0; background:#e5e7eb; color:#111827;
      padding: 7px 12px; border-radius: 999px;
      font-weight: 900; cursor:pointer;
      user-select:none;
    }
    .tabBtn.active{
      background:#111111; color:#ffffff;
    }

    .chartWrap{
      background:#ffffff;
      border: 1.5px solid rgba(0,0,0,.08);
      border-radius: 14px;
      padding: 10px 10px 6px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.02);
    }
    canvas{ width: 100% !important; height: 180px !important; }

    .rows{
      display:grid; gap:8px;
      margin-top: 10px;
    }
    .rowItem{
      display:flex; align-items:center; justify-content:space-between;
      border:1px solid rgba(0,0,0,.08);
      border-radius: 12px;
      padding: 10px 12px;
      background:#fff;
    }
    .rowItem .l{ font-weight: 900; }
    .rowItem .r{ font-weight: 900; color:#111827; }

    .barList{
      border: 1.5px solid rgba(0,0,0,.08);
      border-radius: 14px;
      padding: 12px;
      background:#fff;
    }
    .barHead{
      display:grid;
      grid-template-columns: 70px 1fr 64px 60px;
      gap:10px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      margin-bottom: 8px;
    }
    .barRow{
      display:grid;
      grid-template-columns: 70px 1fr 64px 60px;
      gap:10px;
      align-items:center;
      padding: 6px 0;
    }
    .bar{
      height: 8px;
      border-radius: 999px;
      background: #eef2f7;
      overflow:hidden;
      position:relative;
    }
    .bar > i{
      display:block;
      height:100%;
      width:0%;
      background: #2563eb;
      border-radius: 999px;
    }

    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .pillTab{
      display:flex;
      background:#e5e7eb;
      border-radius: 999px;
      padding: 3px;
      gap: 3px;
      width: fit-content;
    }
    .pillTab button{
      border:0;
      background: transparent;
      padding: 6px 12px;
      border-radius: 999px;
      font-weight: 900;
      cursor:pointer;
      color:#111827;
    }
    .pillTab button.active{
      background:#111111;
      color:#ffffff;
    }

    .hidden{ display:none !important; }

    .ctaRow{
      margin-top: 12px;
      display:flex;
      justify-content:flex-end;
    }
    .cta{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 900;
      text-decoration:none;
      background:#ef4444;
      color:#fff;
      border: 0;
      cursor:pointer;
    }

    .embedWrap{
      margin-top: 12px;
      border-radius: 12px;
      overflow: hidden;
      border: 1.5px solid var(--cardBorder);
      background: #fff;
    }
    .embedFrame{
      width: 100%;
      height: 520px; /* 必要なら調整 */
      border: 0;
      display: block;
    }
    .embedHint{
      padding: 10px 12px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      border-top: 1px solid rgba(0,0,0,.06);
    }
    .embedHint a{
      color: inherit;
      text-decoration: underline;
    }

  </style>
</head>
<body>
  <div class="page">
    <div class="top">
      <div class="logo">Pi<span>xy</span></div>
      <div class="title">インサイト</div>
      <div style="width:40px"></div>
    </div>

    <div class="hr"></div>

    <div class="label">鑑定師名</div>
    <div class="chipRow" id="readerKIDs"></div>

    <div class="sectionTitle">メインデータ</div>

    <div class="chipRow" id="monthChips"></div>

    <div style="height:10px"></div>

    <div class="grid2">
      <div class="card" id="cardReward">
        <div class="cardTitle">今月の報酬金</div>
        <div class="bigMoney" id="kpiReward">¥ 0</div>
        <div class="kpiSub">前月比　<strong id="kpiRewardMoM">-</strong></div>
      </div>

      <div class="card active" id="cardDetail">
        <div class="cardTitle">鑑定データ詳細</div>

        <div class="split">
          <div>
            <div class="kpiSub">リピート件数</div>
            <div class="bigMoney" style="font-size:20px" id="kpiRepeatCount">0</div>
          </div>
          <div>
            <div class="kpiSub">リピート人数</div>
            <div class="bigMoney" style="font-size:20px" id="kpiRepeatUsers">0</div>
          </div>
        </div>

        <div class="miniGrid">
          <div class="miniKpi">
            <div class="k">鑑定件数</div>
            <div class="v" id="kpiTotalCalls">0</div>
          </div>
          <div class="miniKpi">
            <div class="k">鑑定人数</div>
            <div class="v" id="kpiTotalUsers">0</div>
          </div>
        </div>

        <div class="embedWrap">
          <iframe
            class="embedFrame"
            src="https://kuboizaizen.github.io/shino-insight/"
            loading="lazy"
            referrerpolicy="no-referrer"
          ></iframe>
          <div class="embedHint">
            もし真っ白になる場合： <a href="https://kuboizaizen.github.io/shino-insight/" target="_blank" rel="noopener noreferrer">詳細ページを開く</a>
          </div>
        </div>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="tabRow">
      <button class="tabBtn active" data-main="kpi" id="btnMainKPI">メインデータ</button>
      <button class="tabBtn" data-main="repeat" id="btnMainRepeat">回数別</button>
    </div>

    <div id="mainKPI">
      <div class="tabRow" style="margin-top:0">
        <button class="tabBtn active" data-graph="hour" id="btnGraphHour">時間別</button>
        <button class="tabBtn" data-graph="wday" id="btnGraphWday">曜日別</button>
        <button class="tabBtn" data-graph="day" id="btnGraphDay">日別</button>
      </div>

      <div class="chartWrap">
        <canvas id="chart"></canvas>
      </div>

      <div class="rows" id="chartHintRows"></div>
    </div>

    <div id="mainRepeat" class="hidden">
      <div class="sectionTitle" style="font-size:14px; margin-top:8px;">回数別ユーザー数</div>
      <div class="barList">
        <div class="barHead">
          <div>区分</div>
          <div></div>
          <div style="text-align:right;">人数</div>
          <div style="text-align:right;">割合</div>
        </div>
        <div id="p2Rows"></div>
      </div>

      <div class="sectionTitle" style="font-size:14px; margin-top:10px;">終了回数の一覧</div>
      <div class="rows" id="p2EndRows"></div>
    </div>

    <div class="sectionTitle">詳細データ</div>

    <div class="pillTab">
      <button id="btnUserAna" class="active">ユーザー分析</button>
      <button id="btnKanteiAna">鑑定師分析</button>
    </div>

    <div style="height:10px"></div>

    <div id="detailUser" class="card">
      <div class="cardTitle">年齢構成比</div>
      <div class="barList" style="border:0; padding:0;">
        <div id="ageRows"></div>
      </div>

      <div style="height:14px"></div>

      <div class="cardTitle">男女比率</div>
      <div class="barList" style="border:0; padding:0;">
        <div id="genderRows"></div>
      </div>
    </div>

    <div id="detailKantei" class="card hidden">
      <div class="cardTitle">待機時間</div>
      <div class="rows" id="waitRows"></div>

      <div style="height:10px"></div>

      <div class="cardTitle">アフターメッセージ</div>
      <div class="rows" id="afterRows"></div>
    </div>

    <div style="height:16px"></div>
  </div>

<script>
  const APP = {
    state:{
      kid: null,
      month: null,
      graph: "hour",      // hour / wday / day
      mainTab: "kpi",     // kpi / repeat
      detailTab: "user",  // user / kantei
    },
    data:null
  };

  function yen(n){
    if(n===null || n===undefined || Number.isNaN(n)) return "¥ 0";
    const v = Math.round(Number(n) || 0);
    return "¥ " + v.toLocaleString("ja-JP");
    }

  function pct(n){
    if(n===null || n===undefined || Number.isNaN(n)) return "-";
    const v = Number(n);
    return (Math.round(v*10)/10).toFixed(1) + "%";
  }

  function num(n){
    if(n===null || n===undefined || Number.isNaN(n)) return "0";
    const v = Math.round(Number(n) || 0);
    return v.toLocaleString("ja-JP");
  }

  function el(id){ return document.getElementById(id); }

  async function loadJson(){
    const res = await fetch("./insight_data.json?ts=" + Date.now());
    if(!res.ok) throw new Error("json load failed");
    return await res.json();
  }

  function uniq(arr){
    return [...new Set(arr)];
  }

  function setActive(parent, selector, key, val){
    parent.querySelectorAll(selector).forEach(btn=>{
      const ok = btn.getAttribute(key) === val;
      btn.classList.toggle("active", ok);
    });
  }

  function buildKIDChips(){
    const wrap = el("readerKIDs");
    wrap.innerHTML = "";
    const kids = APP.data?.kids || [];
    kids.forEach(k=>{
      const b = document.createElement("button");
      b.className = "chip";
      b.textContent = k.name || k.kid;
      b.onclick = ()=>{
        APP.state.kid = k.kid;
        // デフォ月
        const months = (APP.data.months_by_kid?.[k.kid] || APP.data.months || []);
        APP.state.month = months[0] || APP.state.month;
        syncAll();
      };
      wrap.appendChild(b);
    });
  }

  function buildMonthChips(){
    const wrap = el("monthChips");
    wrap.innerHTML = "";
    const months = (APP.data.months_by_kid?.[APP.state.kid] || APP.data.months || []);
    months.forEach(m=>{
      const b = document.createElement("button");
      b.className = "chip";
      b.textContent = m.replace("-", "月").replace("2025", "").replace("2026", "") + "月";
      b.setAttribute("data-month", m);
      b.onclick = ()=>{
        APP.state.month = m;
        syncAll();
      };
      wrap.appendChild(b);
    });
  }

  // ====== Chart (simple) ======
  const CHART = {
    ctx:null,
    canvas:null,
    w:0,h:0,
    points:[],
    labels:[],
    maxV:0,
    tip:null
  };

  function chartInit(){
    CHART.canvas = el("chart");
    CHART.ctx = CHART.canvas.getContext("2d");
    CHART.tip = document.createElement("div");
    CHART.tip.style.position="fixed";
    CHART.tip.style.pointerEvents="none";
    CHART.tip.style.zIndex=9999;
    CHART.tip.style.background="#fff";
    CHART.tip.style.border="1px solid rgba(0,0,0,.15)";
    CHART.tip.style.borderRadius="10px";
    CHART.tip.style.padding="8px 10px";
    CHART.tip.style.fontWeight="900";
    CHART.tip.style.fontSize="12px";
    CHART.tip.style.boxShadow="0 10px 20px rgba(0,0,0,.12)";
    CHART.tip.style.display="none";
    document.body.appendChild(CHART.tip);

    CHART.canvas.addEventListener("pointermove", (e)=>{
      const rect = CHART.canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const hit = hitTest(x, y);
      if(!hit){
        CHART.tip.style.display="none";
        return;
      }
      const {idx, px, py} = hit;
      const label = CHART.labels[idx] ?? "";
      const value = CHART.points[idx] ?? 0;
      CHART.tip.innerHTML = `${label}<br>${yen(value)}`;
      CHART.tip.style.display="block";
      CHART.tip.style.left = (e.clientX + 10) + "px";
      CHART.tip.style.top = (e.clientY + 10) + "px";
    });
    CHART.canvas.addEventListener("pointerleave", ()=>{
      CHART.tip.style.display="none";
    });
  }

  function hitTest(x,y){
    if(!CHART._dots) return null;
    for(const d of CHART._dots){
      const dx=x-d.x, dy=y-d.y;
      if(dx*dx+dy*dy < 10*10) return {idx:d.i, px:d.x, py:d.y};
    }
    return null;
  }

  function chartDraw(){
    const c = CHART.canvas;
    const ctx = CHART.ctx;
    const rect = c.getBoundingClientRect();
    const w = Math.floor(rect.width * devicePixelRatio);
    const h = Math.floor(rect.height * devicePixelRatio);
    if(c.width !== w) c.width = w;
    if(c.height !== h) c.height = h;

    ctx.clearRect(0,0,w,h);

    const padL = 18*devicePixelRatio;
    const padR = 18*devicePixelRatio;
    const padT = 10*devicePixelRatio;
    const padB = 20*devicePixelRatio;

    const plotW = w - padL - padR;
    const plotH = h - padT - padB;

    const vals = CHART.points;
    const labels = CHART.labels;
    const n = vals.length;
    if(n===0){
      ctx.fillStyle = "rgba(0,0,0,.4)";
      ctx.font = `${12*devicePixelRatio}px system-ui`;
      ctx.fillText("データなし", padL, padT + 20*devicePixelRatio);
      return;
    }

    const maxV = Math.max(...vals, 0);
    CHART.maxV = maxV;

    // grid lines
    ctx.strokeStyle = "rgba(0,0,0,.08)";
    ctx.lineWidth = 1*devicePixelRatio;
    for(let i=0;i<3;i++){
      const yy = padT + (plotH*(i/2));
      ctx.beginPath();
      ctx.moveTo(padL, yy);
      ctx.lineTo(padL+plotW, yy);
      ctx.stroke();
    }

    const dots=[];
    ctx.strokeStyle = "#3b82f6";
    ctx.lineWidth = 2*devicePixelRatio;
    ctx.beginPath();
    for(let i=0;i<n;i++){
      const x = padL + (plotW*(i/(n-1||1)));
      const v = vals[i] || 0;
      const y = padT + plotH - (maxV? (plotH*(v/maxV)) : 0);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      dots.push({i,x,y});
    }
    ctx.stroke();

    // dots
    ctx.fillStyle="#ffffff";
    ctx.strokeStyle="#3b82f6";
    ctx.lineWidth=2*devicePixelRatio;
    dots.forEach(d=>{
      ctx.beginPath();
      ctx.arc(d.x,d.y,4.5*devicePixelRatio,0,Math.PI*2);
      ctx.fill();
      ctx.stroke();
    });
    CHART._dots = dots;

    // x labels (sparse)
    ctx.fillStyle = "rgba(0,0,0,.55)";
    ctx.font = `${10*devicePixelRatio}px system-ui`;
    const step = n>12 ? Math.ceil(n/8) : 1;
    for(let i=0;i<n;i+=step){
      const x = padL + (plotW*(i/(n-1||1)));
      ctx.fillText(labels[i], x-6*devicePixelRatio, padT + plotH + 14*devicePixelRatio);
    }
  }

  function setChartData(labels, values){
    CHART.labels = labels;
    CHART.points = values.map(v=>Number(v)||0);
    chartDraw();
  }

  // ====== Rendering ======
  function getSlice(){
    const kid = APP.state.kid;
    const month = APP.state.month;
    const byKid = APP.data?.by_kid?.[kid] || {};
    const slice = byKid?.[month] || {};
    return slice;
  }

  function syncMainKPI(){
    const slice = getSlice();

    // 報酬
    const reward = slice.reward_month_total ?? 0;
    el("kpiReward").textContent = yen(reward);
    const mom = slice.reward_mom_pct;
    el("kpiRewardMoM").textContent = (mom==null? "-" : pct(mom));

    // 右カード
    el("kpiRepeatCount").textContent = num(slice.repeat_count ?? 0);
    el("kpiRepeatUsers").textContent = num(slice.repeat_users ?? 0);
    el("kpiTotalCalls").textContent = num(slice.total_calls ?? 0);
    el("kpiTotalUsers").textContent = num(slice.total_users ?? 0);
  }

  function syncGraph(){
    const slice = getSlice();
    const g = APP.state.graph;

    if(g==="hour"){
      const items = slice.reward_by_hour || [];
      const labels = items.map(x=>x.label);
      const values = items.map(x=>x.value);
      setChartData(labels, values);
    }
    if(g==="wday"){
      const items = slice.reward_by_wday || [];
      const labels = items.map(x=>x.label);
      const values = items.map(x=>x.value);
      setChartData(labels, values);
    }
    if(g==="day"){
      const items = slice.reward_by_day || [];
      const labels = items.map(x=>x.label);
      const values = items.map(x=>x.value);
      setChartData(labels, values);
    }

    const hint = el("chartHintRows");
    hint.innerHTML = "";
  }

  function syncRepeat(){
    const slice = getSlice();
    const dist = slice.repeat_dist || []; // [{label,count,pct}]
    const wrap = el("p2Rows");
    wrap.innerHTML = "";
    const max = Math.max(...dist.map(x=>x.count||0), 1);
    dist.forEach(x=>{
      const row = document.createElement("div");
      row.className="barRow";
      row.innerHTML = `
        <div style="font-weight:900">${x.label}</div>
        <div class="bar"><i style="width:${Math.round((x.count||0)/max*100)}%"></i></div>
        <div style="text-align:right; font-weight:900">${num(x.count||0)}人</div>
        <div style="text-align:right; font-weight:900">${pct(x.pct||0)}</div>
      `;
      wrap.appendChild(row);
    });

    const ends = slice.end_list || []; // [{label,count}]
    const endWrap = el("p2EndRows");
    endWrap.innerHTML = "";
    ends.forEach(x=>{
      const r = document.createElement("div");
      r.className="rowItem";
      r.innerHTML = `<div class="l">${x.label}</div><div class="r">${num(x.count||0)}人</div>`;
      endWrap.appendChild(r);
    });
  }

  function syncDetail(){
    const slice = getSlice();

    // user tab
    const age = slice.user_age || []; // [{label,pct}]
    const aWrap = el("ageRows");
    aWrap.innerHTML="";
    age.forEach(x=>{
      const row = document.createElement("div");
      row.className="barRow";
      row.style.gridTemplateColumns="70px 1fr 0px 60px";
      row.innerHTML = `
        <div style="font-weight:900">${x.label}</div>
        <div class="bar"><i style="width:${Math.max(0,Math.min(100,Number(x.pct)||0))}%"></i></div>
        <div></div>
        <div style="text-align:right; font-weight:900">${pct(x.pct||0)}</div>
      `;
      aWrap.appendChild(row);
    });

    const gender = slice.user_gender || []; // [{label,pct}]
    const gWrap = el("genderRows");
    gWrap.innerHTML="";
    gender.forEach(x=>{
      const row = document.createElement("div");
      row.className="barRow";
      row.style.gridTemplateColumns="70px 1fr 0px 60px";
      row.innerHTML = `
        <div style="font-weight:900">${x.label}</div>
        <div class="bar"><i style="width:${Math.max(0,Math.min(100,Number(x.pct)||0))}%"></i></div>
        <div></div>
        <div style="text-align:right; font-weight:900">${pct(x.pct||0)}</div>
      `;
      gWrap.appendChild(row);
    });

    // kantei tab
    const wait = slice.kantei_wait || []; // [{label,value}]
    const wWrap = el("waitRows");
    wWrap.innerHTML="";
    wait.forEach(x=>{
      const r = document.createElement("div");
      r.className="rowItem";
      r.innerHTML = `<div class="l">${x.label}</div><div class="r">${x.value}</div>`;
      wWrap.appendChild(r);
    });

    const after = slice.kantei_after || []; // [{label,value}]
    const a2 = el("afterRows");
    a2.innerHTML="";
    after.forEach(x=>{
      const r = document.createElement("div");
      r.className="rowItem";
      r.innerHTML = `<div class="l">${x.label}</div><div class="r">${x.value}</div>`;
      a2.appendChild(r);
    });
  }

  function syncUISelections(){
    // KID active
    const wrap = el("readerKIDs");
    wrap.querySelectorAll(".chip").forEach((b,idx)=>{
      const kid = (APP.data.kids[idx]||{}).kid;
      b.classList.toggle("active", kid === APP.state.kid);
    });

    // months
    buildMonthChips();
    const mWrap = el("monthChips");
    mWrap.querySelectorAll(".chip").forEach(btn=>{
      btn.classList.toggle("active", btn.getAttribute("data-month") === APP.state.month);
    });

    // main tab
    el("mainKPI").classList.toggle("hidden", APP.state.mainTab !== "kpi");
    el("mainRepeat").classList.toggle("hidden", APP.state.mainTab !== "repeat");
    el("btnMainKPI").classList.toggle("active", APP.state.mainTab==="kpi");
    el("btnMainRepeat").classList.toggle("active", APP.state.mainTab==="repeat");

    // graph
    el("btnGraphHour").classList.toggle("active", APP.state.graph==="hour");
    el("btnGraphWday").classList.toggle("active", APP.state.graph==="wday");
    el("btnGraphDay").classList.toggle("active", APP.state.graph==="day");

    // detail tabs
    el("btnUserAna").classList.toggle("active", APP.state.detailTab==="user");
    el("btnKanteiAna").classList.toggle("active", APP.state.detailTab==="kantei");
    el("detailUser").classList.toggle("hidden", APP.state.detailTab!=="user");
    el("detailKantei").classList.toggle("hidden", APP.state.detailTab!=="kantei");
  }

  function syncAll(){
    if(!APP.state.kid){
      APP.state.kid = APP.data?.kids?.[0]?.kid || null;
    }
    if(!APP.state.month){
      const months = (APP.data.months_by_kid?.[APP.state.kid] || APP.data.months || []);
      APP.state.month = months[0] || null;
    }
    syncUISelections();
    syncMainKPI();
    syncGraph();
    syncRepeat();
    syncDetail();
  }

  // ====== Events ======
  el("btnGraphHour").onclick = ()=>{ APP.state.graph="hour"; syncUISelections(); syncGraph(); };
  el("btnGraphWday").onclick = ()=>{ APP.state.graph="wday"; syncUISelections(); syncGraph(); };
  el("btnGraphDay").onclick  = ()=>{ APP.state.graph="day";  syncUISelections(); syncGraph(); };

  el("btnMainKPI").onclick   = ()=>{ APP.state.mainTab="kpi";   syncUISelections(); };
  el("btnMainRepeat").onclick= ()=>{ APP.state.mainTab="repeat"; syncUISelections(); };

  el("btnUserAna").onclick   = ()=>{ APP.state.detailTab="user";   syncUISelections(); };
  el("btnKanteiAna").onclick = ()=>{ APP.state.detailTab="kantei"; syncUISelections(); };

  // ====== Boot ======
  (async ()=>{
    try{
      APP.data = await loadJson();
      buildKIDChips();
      chartInit();
      window.addEventListener("resize", ()=>{ if(APP.state.mainTab==="kpi"){ chartDraw(); } });
      syncAll();
    }catch(e){
      console.error(e);
      alert("insight_data.json の読み込みに失敗しました。");
    }
  })();
</script>
</body>
</html>
